From 5d976309abb20e5377570fa4b62ec51fb858d717 Mon Sep 17 00:00:00 2001
From: Erwan SZYMANSKI <erwan.szymanski@st.com>
Date: Mon, 24 Nov 2025 12:13:34 +0100
Subject: [PATCH] Adapt bootcmd to OpenBMC - SDMMC

Upstream-Status: Pending

Change-Id: I6f7d85ff06b53733eb83576066e73bd53bcb6188
---
 include/configs/stm32mp25_st_common.h | 28 ++++++++++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/include/configs/stm32mp25_st_common.h b/include/configs/stm32mp25_st_common.h
index ab5a4a91644..f7c7b98f75a 100644
--- a/include/configs/stm32mp25_st_common.h
+++ b/include/configs/stm32mp25_st_common.h
@@ -12,6 +12,31 @@
 	"usb_pgood_delay=2000\0" \
 	"console=ttySTM0\0"
 
+#define STM32MP_OBMC_EXTRA_ENV \
+	"bootargs=rw earlyprintk earlycon console=ttySTM0,115200 \0" \
+	"bootside=a\0" \
+	"loadaddr=8a000000\0" \
+	"bootcmd=" \
+		"if test ${boot_device} = serial || test ${boot_device} = usb;" \
+			"then stm32prog ${boot_device} ${boot_instance}; " \
+		"else " \
+			"setenv origbootargs ${bootargs}; run bootsidecmd;" \
+		"fi;\0" \
+	"bootsidecmd=" \
+		"if test ${bootside} = b; then; " \
+			"echo \"Boot over Bootside : B \";" \
+			"run bootb; " \
+			"run boota; " \
+		"else " \
+			"echo \"Boot over Bootside : A \";" \
+			"run boota; " \
+			"run bootb; " \
+		"fi\0" \
+	"boota=setenv bootpart 8; setenv rootfs rofs-a; run bootmmc\0" \
+	"bootb=setenv bootpart 9; setenv rootfs rofs-b; run bootmmc\0" \
+	"bootmmc=run setmmcargs; ext4load mmc 0:${bootpart} ${loadaddr} fitImage && bootm ${loadaddr}; echo Error loading kernel FIT image; bootm ${loadaddr}; echo Error loading kernel FIT image\0" \
+	"setmmcargs=setenv bootargs ${origbootargs} rootwait root=PARTLABEL=${rootfs}\0"
+
 #include <configs/stm32mp25_common.h>
 
 #ifdef CFG_EXTRA_ENV_SETTINGS
@@ -45,7 +70,8 @@
 	ST_STM32MP25_BOOTCMD \
 	BOOTENV \
 	STM32MP_EXTRA \
-	STM32MP_BOARD_EXTRA_ENV
+	STM32MP_BOARD_EXTRA_ENV \
+	STM32MP_OBMC_EXTRA_ENV
 
 #endif
 #endif
-- 
2.34.1

